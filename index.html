<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TkFoodLab V18.1 (å½ˆæ€§åº«å­˜)</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        * { touch-action: manipulation; -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        body { font-family: -apple-system, sans-serif; background: #f0f2f5; margin: 0; padding: 10px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        #role-select { display: flex; flex-direction: column; gap: 20px; margin-top: 100px; width: 100%; max-width: 300px; }
        .role-btn { padding: 30px; font-size: 1.5em; border: none; border-radius: 15px; cursor: pointer; color: white; font-weight: bold; }
        
        #pos-view { display: none; width: 100%; max-width: 400px; flex-direction: column; align-items: center; padding-bottom: 200px; }
        .pos-header { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .settings-btn { background: #7f8c8d; color: white; border: none; padding: 8px 15px; border-radius: 8px; font-size: 0.9em; cursor: pointer; }

        .display { background: #2c3e50; color: #fff; width: 100%; padding: 20px; text-align: right; font-size: 2.5em; font-weight: bold; border-radius: 15px; margin-bottom: 10px; }
        .order-id-display { font-size: 0.4em; color: #ecf0f1; display: block; margin-bottom: 5px; }

        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
        
        .item-btn { 
            padding: 10px 5px; font-size: 1.1em; border: none; border-radius: 10px; color: white; font-weight: bold; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80px; 
            box-shadow: 0 3px 0 rgba(0,0,0,0.1); position: relative;
        }
        .item-btn:active { transform: translateY(2px); box-shadow: none; }
        .item-name { font-size: 1em; }
        .item-price { font-size: 0.8em; opacity: 0.9; }
        
        .stock-tag { font-size: 0.7em; background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; margin-top: 4px; }
        
        /* Colors */
        .btn-food { background: #f39c12; } 
        .btn-drink { background: #3498db; } 
        .btn-combo { background: #27ae60; } 
        .btn-undo { background: #f1c40f; color: #333; grid-column: span 2; margin-top: 5px; }

        /* ğŸ”¥ ä½åº«å­˜ (å°‘æ–¼5 æˆ– è² æ•¸) ä¾ç„¶é–ƒç‡ˆï¼Œä½†å””æœƒè®Šç° */
        .low-stock { background: #e67e22 !important; border: 2px solid #c0392b; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        
        .history-box { width: 100%; margin: 10px 0; background: #fff; border: 2px solid #3498db; padding: 10px; border-radius: 12px; max-height: 150px; overflow-y: auto; font-size: 1.1em; }
        .payment-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; margin-top: 10px; }
        .btn-sumup { background: #0053a0; grid-column: span 2; padding: 20px; font-size: 1.3em; color:white; border:none; border-radius:10px; font-weight:bold; } 
        .btn-cash { background: #27ae60; padding: 15px; font-size: 1.1em; color:white; border:none; border-radius:10px; font-weight:bold;} 
        .btn-clear { background: #e74c3c; padding: 15px; font-size: 1.1em; color:white; border:none; border-radius:10px; font-weight:bold;}

        .stat-box { margin-top: 20px; width: 100%; border-top: 2px dashed #bdc3c7; padding-top: 15px; }
        .total-row { font-size: 1.1em; font-weight: bold; margin-top: 5px; border-top: 1px solid #eee; padding-top: 5px; }
        
        /* Modals */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 999; justify-content: center; align-items: center; }
        .modal-content { background: #fff; width: 90%; max-width: 400px; max-height: 85%; border-radius: 15px; padding: 20px; display: flex; flex-direction: column; }
        .modal-header { font-size: 1.5em; font-weight: bold; margin-bottom: 15px; border-bottom: 2px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex: 1; overflow-y: auto; }
        
        .inv-item { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .inv-label { font-size: 1.1em; font-weight: bold; }
        .inv-input { width: 80px; padding: 8px; font-size: 1.1em; border: 1px solid #bdc3c7; border-radius: 5px; text-align: center; }

        .close-btn { background: #e74c3c; color: white; border: none; padding: 5px 15px; border-radius: 5px; font-size: 0.8em; cursor: pointer; }
        .save-btn { background: #27ae60; color: white; border: none; padding: 12px; border-radius: 8px; font-size: 1.1em; width: 100%; margin-top: 10px; font-weight: bold; cursor: pointer; }
        .clear-hist-btn { background: #95a5a6; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.7em; cursor: pointer; margin-right: 10px;}

        /* History Items */
        .history-item { border-bottom: 1px solid #eee; padding: 10px 0; }
        .h-header { display: flex; justify-content: space-between; font-weight: bold; color: #2c3e50; }
        .h-items { font-size: 0.9em; color: #555; margin-top: 5px; }
        .h-tag { font-size:0.8em; padding:2px 5px; border-radius:4px; color:white; }

        /* Kitchen */
        #kitchen-view { display: none; width: 100%; max-width: 600px; flex-direction: column; gap: 15px; padding-bottom: 50px; }
        .kitchen-toolbar { display: flex; justify-content: space-between; align-items: center; padding: 0 5px; margin-bottom: 10px; }
        .kitchen-btn-group { display: flex; gap: 8px; }
        .k-btn { padding: 8px 12px; border-radius: 8px; border: none; color: white; font-weight: bold; font-size: 0.9em; cursor: pointer; }

        #kitchen-summary { background: #2c3e50; color: white; border-radius: 10px; padding: 15px; margin: 10px 0; box-shadow: 0 4px 8px rgba(0,0,0,0.2); display: none; }
        #summary-content { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-size: 1.2em; font-weight: bold; }
        .summary-item { display: flex; justify-content: space-between; }
        .summary-count { color: #f1c40f; }

        .ticket { background: #fff; border-left: 10px solid #e67e22; padding: 15px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); position: relative; animation: slideIn 0.3s ease-out; margin-bottom: 10px; }
        .ticket-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 10px; }
        .ticket-id { font-size: 2em; font-weight: bold; color: #e67e22; }
        .ticket-time { color: #7f8c8d; font-size: 0.9em; }
        .ticket-items { font-size: 1.4em; font-weight: bold; color: #2c3e50; line-height: 1.4; }
        .ticket-action { margin-top: 15px; text-align: right; }
        .btn-done { background: #27ae60; padding: 10px 20px; font-size: 1.2em; border-radius: 5px; min-height: auto; box-shadow: none; display: inline-block; color: white; border: none; cursor: pointer; }
        
        @keyframes slideIn { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .emoji { font-size: 1.4em; display: block; margin-bottom: 5px;}
    </style>
</head>
<body>

    <div id="inventoryModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>ğŸ“¦ åº«å­˜è¨­å®š</span>
                <button class="close-btn" onclick="closeInventory()">å–æ¶ˆ</button>
            </div>
            <div style="font-size:0.8em; color:#7f8c8d; margin-bottom:10px;">* åŒé¡ç”¢å“æœƒå…±ç”¨åº«å­˜ (Shared Pool)</div>
            <div class="modal-body" id="inventoryList"></div>
            <button class="save-btn" onclick="saveInventory()">ğŸ’¾ å„²å­˜è¨­å®š</button>
        </div>
    </div>

    <div id="historyModal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span id="modalTitle">ğŸ“œ ç´€éŒ„</span>
                <div>
                    <button class="clear-hist-btn" onclick="clearLocalHistory()">æ¸…ç©º</button>
                    <button class="close-btn" onclick="closeHistory()">é—œé–‰</button>
                </div>
            </div>
            <div class="modal-body" id="modalListContent"></div>
        </div>
    </div>

    <div id="role-select">
        <h2 style="text-align:center; color:#555;">TkFoodLab V18.1</h2>
        <button class="role-btn" style="background:#3498db;" onclick="selectRole('pos')">ğŸª æˆ‘ä¿‚æ”¶éŠ€ (POS)</button>
        <button class="role-btn" style="background:#e67e22;" onclick="selectRole('kitchen')">ğŸ‘¨â€ğŸ³ æˆ‘ä¿‚å»šæˆ¿ (Kitchen)</button>
    </div>

    <div id="pos-view">
        <div class="pos-header">
            <span style="font-weight:bold; color:#555;">TkFoodLab</span>
            <button class="settings-btn" onclick="openInventory()">âš™ï¸ è¨­å®šåº«å­˜</button>
        </div>

        <div class="display" id="total">
            <span class="order-id-display">NEXT ORDER: <span id="nextOrderNum">#001</span></span>
            <span id="priceDisplay">Â£ 0.00</span>
        </div>
        
        <div class="grid" id="menuGrid"></div>

        <div class="history-box">
            <div style="font-size:0.8em;color:#888;">ç•¶å‰å–®æ“š:</div>
            <strong id="log">ç©º</strong>
        </div>

        <div class="payment-grid">
            <button class="btn-sumup" onclick="payWithSumUp()">ğŸ’³ SumUp</button>
            <button class="btn-cash" onclick="payWithCash()">ğŸ’µ Cash</button>
            <button class="btn-clear" onclick="nextCustomer()">âŒ æ¸…é™¤</button>
        </div>
        
        <div class="stat-box">
            <button onclick="showPosHistory()" style="background:#34495e; color:#fff; font-size:1em; padding:12px; width:100%; margin-bottom:15px; border:none; border-radius:8px;">ğŸ“œ æŸ¥çœ‹ä»Šæ—¥ç´€éŒ„</button>

            <div class="total-row" style="color:#27ae60;">ç¾é‡‘: Â£ <span id="cashTotal">0.00</span></div>
            <div class="total-row" style="color:#0053a0;">SumUp: Â£ <span id="sumupTotal">0.00</span></div>
            <div class="total-row" style="color:#c0392b;">ç¸½æ”¶: Â£ <span id="grandTotal">0.00</span></div>
            
            <button onclick="downloadCSV()" style="background:#27ae60; color:#fff; font-size:0.9em; margin-top:15px; padding:12px; width:100%; border:none; border-radius:8px;">ğŸ“¥ ä¸‹è¼‰ Excel å ±è¡¨</button>
            <button onclick="clearAllData()" style="background:#bdc3c7; color:#333; font-size:0.8em; margin-top:10px; padding:10px; width:100%; border:none; border-radius:8px;">ğŸ”´ æ”¶å¸‚æ¸…æ©Ÿ</button>
        </div>
    </div>

    <div id="kitchen-view">
        <div class="kitchen-toolbar">
            <h2 style="color:#444; margin:0;">ğŸ‘¨â€ğŸ³ å»šæˆ¿</h2>
            <div class="kitchen-btn-group">
                <button onclick="undoLastOrder()" class="k-btn" style="background:#f39c12;">â†©ï¸ å¾©åŸ (Undo)</button>
                <button onclick="showKitchenHistory()" class="k-btn" style="background:#34495e;">ğŸ“œ ç´€éŒ„</button>
            </div>
        </div>
        
        <div id="kitchen-summary">
            <div style="border-bottom:1px solid #7f8c8d; margin-bottom:5px; color:#bdc3c7;">ğŸ“ å¾…è£½ä½œç¸½æ•¸:</div>
            <div id="summary-content"></div>
        </div>
        <div id="ticket-list">
            <div style="text-align:center; color:#999; margin-top:50px;">æº–å‚™æ¥å–®...</div>
        </div>
    </div>

    <audio id="cashSound" src="https://assets.mixkit.co/active_storage/sfx/2013/2013-preview.mp3"></audio>

    <script>
        // âœ… Menu
        const menuItems = [
            { id: 'satay', name: 'ğŸ¢ æ²™çˆ¹', price: 5.00, type: 'food' },
            { id: '3treasures', name: 'ğŸ† ä¸‰å¯¶', price: 4.00, type: 'food' },
            { id: 'fins', name: 'ğŸ¥£ ç¢—ä»”ç¿…', price: 4.50, type: 'food' },
            { id: 'fish', name: 'ğŸŸ é­šè‚‰', price: 3.50, type: 'food' },
            { id: 'mix', name: 'ğŸ² å…©æº', price: 5.00, type: 'food' },
            
            { id: 'mango', name: 'ğŸ¥­ğŸ¥¥ èŠ’æ¤°', price: 4.50, type: 'drink', stockId: 'pool_mango' },
            { id: 'purple', name: 'ğŸŸ£ğŸ¥¥ ç´«æ¤°', price: 4.50, type: 'drink', stockId: 'pool_purple' },
            
            { id: 'cmango', name: 'â•ğŸ¥­ é¤èŠ’', price: 3.00, type: 'combo', stockId: 'pool_mango' },
            { id: 'cpurple', name: 'â•ğŸŸ£ é¤ç´«', price: 3.00, type: 'combo', stockId: 'pool_purple' }
        ];

        // âœ… Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyAwf89HosgmxTH4daR_IIdzKMBwhxxTx3E",
            authDomain: "tkfoodlab-94f22.firebaseapp.com",
            databaseURL: "https://tkfoodlab-94f22-default-rtdb.firebaseio.com",
            projectId: "tkfoodlab-94f22",
            storageBucket: "tkfoodlab-94f22.firebasestorage.app",
            messagingSenderId: "849545681320",
            appId: "1:849545681320:web:e7a95fb424809d3573659d",
            measurementId: "G-ZTKPS5DZ0Y"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let currentRole = '';
        let currentOrder = [];
        let allStats = JSON.parse(localStorage.getItem('marketStats')) || {};
        let transactionHistory = JSON.parse(localStorage.getItem('marketHistory')) || [];
        let kitchenHistory = JSON.parse(localStorage.getItem('kitchenHistory')) || [];
        let dailyCash = Number(localStorage.getItem('marketCash')) || 0;
        let dailySumUp = Number(localStorage.getItem('marketSumUp')) || 0;
        let orderCount = parseInt(localStorage.getItem('orderCount')) || 1; 
        let inventory = JSON.parse(localStorage.getItem('marketInventory')) || {};

        function playCashSound() {
            let audio = document.getElementById('cashSound');
            audio.currentTime = 0; audio.play().catch(e => {});
        }

        function selectRole(role) {
            currentRole = role;
            document.getElementById('role-select').style.display = 'none';
            if (role === 'pos') {
                document.getElementById('pos-view').style.display = 'flex';
                renderMenu();
                updateUI();
            } else {
                document.getElementById('kitchen-view').style.display = 'flex';
                initKitchenListener();
            }
        }

        // === Menu & Inventory ===
        function renderMenu() {
            const grid = document.getElementById('menuGrid');
            grid.innerHTML = '';
            
            menuItems.forEach(item => {
                let btn = document.createElement('button');
                btn.className = `item-btn btn-${item.type}`;
                
                let checkId = item.stockId || item.id;
                let stock = inventory[checkId];
                let stockText = '';
                
                if (stock !== undefined && stock !== null && stock !== '') {
                    stock = parseInt(stock);
                    // ğŸš¨ æ”¹å‹•ï¼šé¡¯ç¤ºè² æ•¸ï¼Œå””æœƒé–æ£
                    stockText = `<span class="stock-tag">å‰© ${stock}</span>`;
                    
                    if (stock <= 5) {
                        btn.classList.add('low-stock');
                        stockText = `<span class="stock-tag">ğŸ”¥å‰© ${stock}</span>`;
                    }
                    if (stock <= 0) {
                        stockText = `<span class="stock-tag">âš ï¸å‰© ${stock}</span>`;
                    }
                }
                btn.innerHTML = `<span class="emoji">${item.name.split(' ')[0]}</span><span class="item-name">${item.name.split(' ').slice(1).join(' ')}</span><span class="item-price">Â£${item.price.toFixed(2)}</span>${stockText}`;
                
                // ğŸš¨ æ”¹å‹•ï¼šæ°¸é å¯ä»¥æ’³
                btn.onclick = () => add(item);
                
                grid.appendChild(btn);
            });

            let undoBtn = document.createElement('button');
            undoBtn.className = 'item-btn btn-undo';
            undoBtn.innerHTML = '<span class="emoji">ğŸ”™</span> UNDO';
            undoBtn.onclick = backspace;
            grid.appendChild(undoBtn);
        }

        function openInventory() {
            const list = document.getElementById('inventoryList');
            list.innerHTML = '';
            let seenStockIds = {}; 

            menuItems.forEach(item => {
                let useId = item.stockId || item.id;
                if (seenStockIds[useId]) return;
                seenStockIds[useId] = true;

                let val = inventory[useId];
                if(val === undefined || val === null) val = '';
                
                let displayName = item.name;
                if(item.stockId) displayName += " (å…±ç”¨)";
                list.innerHTML += `<div class="inv-item"><span class="inv-label">${displayName}</span><input type="number" class="inv-input" id="inv-${useId}" value="${val}" placeholder="âˆ"></div>`;
            });
            document.getElementById('inventoryModal').style.display = 'flex';
        }

        function saveInventory() {
            let seenStockIds = {};
            menuItems.forEach(item => {
                let useId = item.stockId || item.id;
                if(seenStockIds[useId]) return; 
                seenStockIds[useId] = true;
                let input = document.getElementById(`inv-${useId}`);
                if (input) {
                    let val = input.value;
                    if (val === '') delete inventory[useId]; else inventory[useId] = parseInt(val);
                }
            });
            localStorage.setItem('marketInventory', JSON.stringify(inventory));
            closeInventory(); renderMenu();
        }
        function closeInventory() { document.getElementById('inventoryModal').style.display = 'none'; }

        // === POS ===
        function add(item) { currentOrder.push(item); updateUI(); let box = document.querySelector('.history-box'); box.scrollTop = box.scrollHeight; }
        function backspace() { if(currentOrder.length > 0) { currentOrder.pop(); updateUI(); } }
        function payWithCash() { if (currentOrder.length === 0) return; playCashSound(); let total = calculateTotal(); dailyCash += total; processOrder("Cash", total); updateUI(); }
        function payWithSumUp() {
            let total = calculateTotal(); if (total <= 0) return; playCashSound(); dailySumUp += total; processOrder("SumUp", total); updateUI();
            const affiliateKey = "sup_afk_0iCXN24RDImFTW7FuzTeIzZLgpY81W9n"; 
            let appId = "app.netlify.tkfoodlab"; 
            let summary = currentOrder.map(i => i.name.replace(/[^\w\s\u4e00-\u9fa5]/g, '')).join('+');
            let url = `sumupmerchant://pay/1.0?amount=${total.toFixed(2)}&currency=GBP&affiliate-key=${affiliateKey}&app-id=${appId}&title=${encodeURIComponent(summary)}&paymentType=card_reader`;
            setTimeout(() => { window.location.href = url; }, 300);
        }
        function processOrder(method, total) {
            let formattedID = String(orderCount).padStart(3, '0');
            let time = new Date().toLocaleTimeString('en-GB', {hour12:false, hour:'2-digit', minute:'2-digit'});
            let itemsStr = currentOrder.map(i => i.name).join(' + ');
            
            // ğŸš¨ æ”¹å‹•ï¼šå®¹è¨±è² æ•¸æ‰£æ¸›
            currentOrder.forEach(orderItem => {
                let deductId = orderItem.stockId || orderItem.id;
                let stock = inventory[deductId];
                if (stock !== undefined && stock !== null) {
                    inventory[deductId] = stock - 1; // ç§»é™¤ Math.max(0)
                }
            });
            localStorage.setItem('marketInventory', JSON.stringify(inventory)); renderMenu();

            transactionHistory.unshift({ id: formattedID, time: time, items: itemsStr, amount: total.toFixed(2), method: method });
            currentOrder.forEach(item => { allStats[item.name] = (allStats[item.name] || 0) + 1; });

            db.ref('orders').push({ id: formattedID, items: itemsStr, time: time, method: method, timestamp: firebase.database.ServerValue.TIMESTAMP });

            orderCount++; saveData(); if(method === "Cash") { currentOrder = []; }
        }
        function nextCustomer() { currentOrder=[]; updateUI(); }
        function calculateTotal() { return currentOrder.reduce((s,i)=>s+i.price,0); }
        function updateUI() {
            try {
                let total = calculateTotal();
                document.getElementById('priceDisplay').innerText = 'Â£ ' + total.toFixed(2);
                document.getElementById('log').innerText = currentOrder.map(i => i.name).join(' + ') || 'ç©º';
                document.getElementById('nextOrderNum').innerText = '#' + String(orderCount).padStart(3, '0');
                document.getElementById('cashTotal').innerText = Number(dailyCash).toFixed(2);
                document.getElementById('sumupTotal').innerText = Number(dailySumUp).toFixed(2);
                document.getElementById('grandTotal').innerText = (Number(dailyCash) + Number(dailySumUp)).toFixed(2);
            } catch (e) {}
        }
        function saveData() {
            localStorage.setItem('marketStats', JSON.stringify(allStats));
            localStorage.setItem('marketHistory', JSON.stringify(transactionHistory));
            localStorage.setItem('marketCash', dailyCash);
            localStorage.setItem('marketSumUp', dailySumUp);
            localStorage.setItem('orderCount', orderCount);
        }
        function clearAllData() {
            if(confirm('ğŸ”´ è­¦å‘Šï¼šç¢ºå®šè¦æ¸…ç©ºä»Šæ—¥ POS æ‰€æœ‰ç´€éŒ„ï¼Ÿ\n(åº«å­˜æ•¸é‡ä¸æœƒè¢«é‡ç½®)')) {
                allStats = {}; transactionHistory = []; dailyCash = 0; dailySumUp = 0; currentOrder = []; orderCount = 1; saveData(); updateUI();
            }
        }
        function downloadCSV() {
             if (transactionHistory.length === 0) { alert("æœªæœ‰ç´€éŒ„"); return; }
            let csv = "\uFEFFå–®è™Ÿ,æ™‚é–“,å…§å®¹,é‡‘é¡,æ–¹å¼\n";
            transactionHistory.forEach(r => { csv += `#${r.id},${r.time},"${r.items}",Â£${r.amount},${r.method}\n`; });
            let blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            let link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `sales_${new Date().toISOString().slice(0,10)}.csv`;
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        }

        // === Kitchen ===
        function initKitchenListener() {
            const list = document.getElementById('ticket-list');
            db.ref('orders').orderByChild('timestamp').limitToLast(20).on('child_added', (snapshot) => {
                const order = snapshot.val();
                const key = snapshot.key;
                playCashSound(); 
                if(list.innerText.includes('æº–å‚™æ¥å–®')) list.innerHTML = '';
                let card = document.createElement('div');
                card.className = 'ticket'; card.id = key;
                card.dataset.id = order.id; card.dataset.time = order.time; card.dataset.items = order.items; card.dataset.method = order.method;
                card.innerHTML = `<div class="ticket-header"><span class="ticket-id">#${order.id}</span><span class="ticket-time">${order.time}</span></div><div class="ticket-items">${order.items}</div><div class="ticket-action"><button class="btn-done" onclick="completeOrder('${key}')">âœ… å‡ºé¤ Done</button></div>`;
                list.prepend(card);
                updateKitchenStats();
            });
            db.ref('orders').on('child_removed', (snapshot) => {
                const el = document.getElementById(snapshot.key);
                if (el) el.remove();
                updateKitchenStats();
            });
        }
        function updateKitchenStats() {
            let summaryBox = document.getElementById('kitchen-summary');
            let contentBox = document.getElementById('summary-content');
            let activeTickets = document.querySelectorAll('.ticket');
            if(activeTickets.length === 0) { summaryBox.style.display = 'none'; return; }
            let counts = {};
            activeTickets.forEach(ticket => {
                let itemsStr = ticket.dataset.items; if(!itemsStr) return;
                let items = itemsStr.split(' + ');
                items.forEach(item => { counts[item] = (counts[item] || 0) + 1; });
            });
            let html = "";
            for (let [item, count] of Object.entries(counts)) { html += `<div class="summary-item"><span>${item}</span><span class="summary-count">x${count}</span></div>`; }
            contentBox.innerHTML = html;
            summaryBox.style.display = 'block';
        }
        function completeOrder(key) {
            let el = document.getElementById(key);
            if(el) {
                let id = el.dataset.id; let time = el.dataset.time; let items = el.dataset.items;
                let doneTime = new Date().toLocaleTimeString('en-GB', {hour12:false, hour:'2-digit', minute:'2-digit'});
                let method = el.dataset.method || 'Unknown'; 
                kitchenHistory.unshift({ id: id, items: items, inTime: time, doneTime: doneTime, method: method });
                localStorage.setItem('kitchenHistory', JSON.stringify(kitchenHistory));
            }
            db.ref('orders').child(key).remove();
        }
        
        function undoLastOrder() {
            if (kitchenHistory.length === 0) { alert("å†‡å˜¢å¯ä»¥å¾©åŸï¼"); return; }
            let lastOrder = kitchenHistory[0];
            if(!confirm(`ç¢ºå®šè¦é‚„åŸå–®è™Ÿ #${lastOrder.id}?`)) return;
            kitchenHistory.shift(); localStorage.setItem('kitchenHistory', JSON.stringify(kitchenHistory));
            db.ref('orders').push({ id: lastOrder.id, items: lastOrder.items, time: lastOrder.inTime, method: lastOrder.method || 'Restored', timestamp: firebase.database.ServerValue.TIMESTAMP });
            if(document.getElementById('historyModal').style.display === 'flex') { renderList(kitchenHistory, 'kitchen'); }
        }

        // === Modal Functions ===
        function showPosHistory() { document.getElementById('modalTitle').innerText = "ğŸ“œ POS ä»Šæ—¥ç´€éŒ„"; renderList(transactionHistory, 'pos'); document.getElementById('historyModal').style.display = 'flex'; }
        function showKitchenHistory() { document.getElementById('modalTitle').innerText = "ğŸ“œ å»šæˆ¿å·²å‡ºé¤ç´€éŒ„"; renderList(kitchenHistory, 'kitchen'); document.getElementById('historyModal').style.display = 'flex'; }
        function renderList(data, type) {
            let listDiv = document.getElementById('modalListContent');
            if (data.length === 0) { listDiv.innerHTML = '<div style="text-align:center;margin-top:20px;color:#999">æš«ç„¡ç´€éŒ„</div>'; return; }
            let html = '';
            data.forEach(t => {
                if(type === 'pos') html += `<div class="history-item"><div class="h-header"><span>#${t.id} - ${t.time}</span><span class="h-tag" style="background:${t.method=='Cash'?'#27ae60':'#0053a0'}">${t.method} Â£${t.amount}</span></div><div class="h-items">${t.items}</div></div>`;
                else html += `<div class="history-item"><div class="h-header"><span>#${t.id}</span><span style="font-size:0.8em;color:#7f8c8d">å…¥: ${t.inTime} / å‡º: ${t.doneTime}</span></div><div class="h-items">${t.items}</div></div>`;
            });
            listDiv.innerHTML = html;
        }
        function closeHistory() { document.getElementById('historyModal').style.display = 'none'; }
        function clearLocalHistory() { if(currentRole === 'pos') alert("POS ç´€éŒ„è«‹åœ¨ä¸»ç•«é¢æŒ‰ã€Œæ”¶å¸‚æ¸…æ©Ÿã€"); else if(confirm("ç¢ºå®šæ¸…ç©ºã€Œå·²å‡ºé¤ç´€éŒ„ã€ï¼Ÿ")) { kitchenHistory = []; localStorage.setItem('kitchenHistory', JSON.stringify([])); renderList([], 'kitchen'); } }
    </script>
</body>
</html>